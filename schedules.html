<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Unofficial Texas Eclipse App - Lineup</title>
  <link href="https://unpkg.com/vue-multiselect@3.0.0-beta.3/dist/vue-multiselect.esm.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
  <!-- Primary Meta Tags -->
  <title>The Unofficial Texas Eclipse App</title>
  <meta name="title" content="The Unofficial Texas Eclipse App" />
  <meta name="description"
    content="View the line-up and discover artists by genre. Add them to your schedule and curate your day. 100% Offline. Your data belongs to you." />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://texas-eclipse2024.vercel.app/schedules.html" />
  <meta property="og:title" content="The Unofficial Texas Eclipse App - Keep your Data" />
  <meta property="og:description"
    content="View the line-up and discover artists by genre. Add them to your schedule and curate your day. 100% Offline. Your data belongs to you." />
  <meta property="og:image" content="/assets/preview2.png" />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://texas-eclipse2024.vercel.app/schedules.html" />
  <meta property="twitter:title" content="The Unofficial Texas Eclipse App - Keep your Data" />
  <meta property="twitter:description"
    content="View the line-up and discover artists by genre. Add them to your schedule and curate your day. 100% Offline. Your data belongs to you." />
  <meta property="twitter:image" content="/assets/preview2.png" />

  <!-- Meta Tags Generated with https://metatags.io -->
</head>

<body>
  <script type="importmap">
    { 
      "imports": {
        "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
        "vue-multiselect": "https://unpkg.com/vue-multiselect@3.0.0-beta.3/dist/vue-multiselect.esm.js",
        "date-fns": "https://cdn.jsdelivr.net/npm/date-fns@3.6.0/+esm",
        "date-fns-tz": "https://cdn.jsdelivr.net/npm/date-fns-tz@3.0.0-beta.3/+esm"
      }
    }
  </script>
  <div id="app">
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-item" href="/">
          Go to Map
        </a>
        <a class="navbar-item" href="/my-schedule.html">
          Go to My Schedule
        </a>
      </div>
    </nav>
    <div class="github">
      <iframe src="https://ghbtns.com/github-btn.html?user=courtyenn&repo=texas_eclipse2024&type=star&count=true"
        frameborder="0" scrolling="0" width="150" height="20" title="GitHub"></iframe>
    </div>
    <section class="section">
      <div class="container">
        <h1 class="title">
          Lineup
        </h1>
        <div class="spacex fixed-grid has-1-cols-mobile has-2-cols">
          <div class="grid">
            <div class="cell">
              <multiselect v-model="search" placeholder="Search by name.." :options="eventNames" @remove="onSelect" />
            </div>

            <div class="cell">
              <multiselect v-model="selectedTags" :options="tags" :multiple="true" :preserve-search="true"
                :close-on-select="false" placeholder="Select tag(s)"></multiselect>
            </div>
            <div class="cell">
              <multiselect v-model="selectedStages" :options="stages" :multiple="true" :close-on-select="false"
                placeholder="Select Stage(s)"></multiselect>
            </div>
            <div class="cell">
              <multiselect v-model="selectedDays"
                :options="[{label: 'Friday', value: 5}, {label: 'Saturday', value: 6}, {label: 'Sunday', value: 0}, {label: 'Monday', value: 1}, {label: 'Tuesday', value: 2}]"
                :multiple="true" :close-on-select="false" placeholder="Select Day(s)" track-by="value" label="label">
              </multiselect>
            </div>
            <div class="cell">
              <button @click="selectedTags = [];search='';selectedDays=[];selectedStages=[];"
                class="button">Clear</button> Results: {{ filteredEvents.length }}
            </div>
          </div>
        </div>
        <ul class="event-list">
          <li v-for="event in filteredEvents" :key="event.id">
            <div :class="`card ${event.location?.toLowerCase()?.replace(' ', '')}`">
              <div class="card-content">
                <div class="title houston">
                  <h2 class="lunar-rover">
                    {{ event.title }}
                    <div class="tags">
                      <span v-for="tag in event.tags" :key="tag"
                        :class="`tag ${Object.keys(tagMap).filter(k => tagMap[k].includes(tag))[0]}`">{{ tag }}
                      </span>
                    </div>
                    <span v-if="event.ig" class="subtitle">
                      <a :href="`https://www.${event.ig}`" class=" has-text-primary">@{{event.ig.split('/').pop()}}</a>
                    </span>
                  </h2>
                  <div class="is-flex is-flex-direction-column timewarp">
                    <button v-if="!dayContainsEvent(event)" class="button is-primary" type="button"
                      @click="addToMySchedule(event)">
                      Add to schedule
                    </button>
                    <button v-if="dayContainsEvent(event)" class="button is-primary" type="button"
                      @click="removeFromMySchedule(event)">
                      Remove from schedule
                    </button>
                    <time class="is-size-4">{{ daysOfWeek[event.startTime.getDay()] }}</time>
                    <time :datetime="event.formatStartTime" class="is-size-6 has-text-grey-dark">
                      {{ event.formatStartTime }} - {{
                      event.formatEndTime }}
                    </time>
                  </div>
                </div>
                <div class="content">
                  <p v-if="event.description">{{ event.description }}</p>
                  <p v-if="event.website">{{ event.website }}</p>
                </div>
                <div class="cats" v-if="coreStages.includes(event.location)">
                  <img class="symbol" :src="`/assets/${event.location?.toLowerCase()?.replace(' ', '')}_stage.png`"
                    :alt="`${event.location} area`" />
                  <h4 class="title is-size-4"> {{event.location}}</h4>
                </div>
                <h4 v-if="!coreStages.includes(event.location)" class="title is-size-4">Stage: {{event.location}}</h4>
              </div>
            </div>
          </li>
        </ul>
      </div>
  </div>
  </section>
  <script type="module">
    import { createApp, ref, onMounted, computed, reactive } from 'vue'
    import VueMultiselect from 'vue-multiselect'
    import { formatInTimeZone, zonedTimeToUtc, utcToZonedTime, format } from 'date-fns-tz'

    const tagMap = ref({
      "is-dark": ["dark", "emo", "rock", "experimental", "club", "space", "psywave", "acid", "tranquil", "art", "riddim"],
      "is-primary": ["electronica", "synth", "bass", "indie", "sophistication", "slo-mo", "soundscape", "light show"],
      "is-link": ["house", "ethnic", "jungle", "retro", "lo-fi", "futuristic", "glitch", "math", "arcade"],
      "is-info": ["blues", "afro", "folk", "psytrance", "dnb", "disco", "hardstyle", "hip hop", "astrology"],
      "is-warning": ["happy", "jazzy", "folktronica", "funky", "dubstep", "bpm", "humanitarianism", "comedy", "medicine"],
      "is-danger": ["renegade", "industrial", "upbeat", "indigenous", "eerie", "classy", "AI", "b2b"],
      "is-success": ["spiritual", "trippy", "vocals", "trance", "forest", "downtempo", "innovation", "trap"],
      "is-light": ["progressive", "consciousness", "techno", "remix", "dreamy", "acoustics", "crypto", "ambient"],
    });
    const coreStages = ["Sky", "Sun", "Lone Star", "Earth", "Eclipse", "Moon"];
    const STORAGE = 'TexasEclipseSchedulev2';
    const TIMEZONE = 'America/Chicago'
    const schedule = JSON.parse(localStorage.getItem(STORAGE)) || {
      Friday: [],
      Saturday: [],
      Sunday: [],
      Monday: [],
      Tuesday: [],
    };
    for (let k in schedule) {
      schedule[k] = schedule[k].map((event) => {
        event.startTime = new Date(event.startTime)
        event.endTime = new Date(event.endTime)
        return event
      })
    }

    const savedData = reactive(schedule)

    /** DATA SCRIPTS **/
    const fixData = (events) => {
      const STORAGE_FIX = 'fixedIds'
      const didFixIds = ref(localStorage.getItem(STORAGE_FIX) ? JSON.parse(localStorage.getItem(STORAGE_FIX)) : false);
      if (!didFixIds.value) {
        const schedule = localStorage.getItem(STORAGE) ? JSON.parse(localStorage.getItem('TexasEclipseSchedulev2')) : {};
        for (let day in schedule) {
          // old ID: loopus-in-fabula-2024-04-05t20-00-00-000z
          // new ID: loopus-in-fabula-2024-04-05t19-00-00-000z
          schedule[day] = schedule[day].map(event => {
            event.id = event.id.replace(/([0-9]{2})t([0-9]{2})(-[0-9]{2}-[0-9]{2}-[0-9]{3}z)$/, (_, day, hour, rest) => {
              hour = parseInt(hour);
              if (hour === 0) {
                day = parseInt(day);
                day -= 1;
                day = "" + day;
                return day.padStart(2, "0") + "t23" + rest;
              }
              hour -= 1;
              hour = "" + hour;
              if (hour.length < 2) hour = "0" + hour;
              return day + "t" + hour + rest;
            });
            return events.find(realEvent => realEvent.id === event.id) || event;
          })
          savedData[day] = schedule[day]
        }
        localStorage.setItem(STORAGE, JSON.stringify(schedule));
        localStorage.setItem(STORAGE_FIX, JSON.stringify(true));
      }
    }
    const fixScheduleSort = () => {
      const FIX = 'didSortSavedSchedule'
      const didSortSavedSchedule = localStorage.getItem(FIX) ? JSON.parse(localStorage.getItem(FIX)) : false;
      if (!didSortSavedSchedule) {
        for (let day in savedData) {
          savedData[day] = savedData[day].sort((a, b) => {
            if (a.startTime > b.startTime) return 1;
            if (a.startTime < b.startTime) return -1
            return 0
          })
        }
        localStorage.setItem(STORAGE, JSON.stringify(savedData));
        localStorage.setItem(FIX, JSON.stringify(true));
      }
    }
    /** End Data scripts **/
    const removeDuplicates = (arr) => arr.filter((v, i) => arr.indexOf(v) === i);
    const transformData = (data) => data.map((item) => {
      let newId = item.eventartistworkshoppresentation.replace(/[\s&]+/g, '-').toLowerCase()
      newId += '-' + item.starttime.replace(/[\s:.]+/g, '-').toLowerCase()

      const startTime = new Date(item.starttime)
      const endTime = new Date(item.endtime)
      const timeZoneStart = utcToZonedTime(startTime, TIMEZONE)
      const timeZoneEnd = utcToZonedTime(endTime, TIMEZONE)
      return {
        id: newId,
        /*
         * Start time and End time are deprecated in favor of timeZoneStart and timeZoneEnd. Instead of updating people's app every time, check for the new values and if they are there then perform an update.
        */
        startTime,
        endTime,
        timeZoneStart,
        timeZoneEnd,
        formatStartTime: formatInTimeZone(startTime, TIMEZONE, 'p'),
        formatEndTime: formatInTimeZone(endTime, TIMEZONE, 'p'),
        tags: item.tags.split(', '),
        title: item.eventartistworkshoppresentation,
        description: item.description,
        website: item.website,
        ig: item.ig,
        location: item.areastagelatlng
      }
    });

    const app = createApp({
      setup() {
        const sortedStages = ['Consciousness', 'Earth', 'Eclipse', 'Lone Star', 'Moon', 'Sky', 'Space', 'Sun', 'Texas On Chain'];
        const daysOfWeek = ref(['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']);
        const presentationTags = ref(['presentation', 'art', 'crypto', 'math', 'light show', 'humanitarianism', 'innovation', 'AI', 'comedy', 'astrology']);
        const mySchedule = reactive([]);
        const value = ref();
        const events = ref([])
        const eventNames = ref([]);
        const stages = ref([])
        const days = ref([])
        const eventTypes = ref([])
        const search = ref('')
        const selectedTags = ref([])
        const tags = ref([])
        const selectedStages = ref([])
        const selectedDays = ref([])
        const filteredEvents = computed({
          get() {
            return events.value.filter((event) => {
              return event.title.toLowerCase().includes(search.value.toLowerCase()) && (selectedTags.value.length === 0 || selectedTags.value.every((tag) => event.tags.includes(tag))) && (selectedDays.value.length === 0 || selectedDays.value.find(v => v.value === event.startTime.getDay())) && (selectedStages.value.length === 0 || selectedStages.value.includes(event.location))
            }).sort((a, b) => a.startTime - b.endTime)
          }
        })
        const dayContainsEvent = (event) => {
          const day = daysOfWeek.value[event.startTime.getDay()]
          return savedData[day].some((savedEvent) => savedEvent.id === event.id)
        };

        const detectConflict = () => {
          for (let i = 0; i < mySchedule.length - 1; i++) {
            if (mySchedule[i].endTime > mySchedule[i + 1].startTime) {
              console.log("conflict detected")
            }
          }
        }
        const addToMySchedule = (data) => {
          const day = daysOfWeek.value[data.startTime.getDay()]
          data.formatStartTime = formatInTimeZone(data.startTime, TIMEZONE, 'p')
          data.formatEndTime = formatInTimeZone(data.endTime, TIMEZONE, 'p')
          if (savedData[day].length > 0) {
            let indexToSlice = savedData[day].length;
            for (let i = 0; i < savedData[day].length; i++) {
              const event = savedData[day][i];
              if (event.startTime >= data.startTime) {
                indexToSlice = i;
                break;
              }
            };
            const p1 = savedData[day].slice(0, indexToSlice);
            const p2 = savedData[day].slice(indexToSlice);
            savedData[day] = p1.concat(data, p2);
          } else {
            savedData[day].push(data);
          }
          localStorage.setItem(STORAGE, JSON.stringify(savedData))

        }
        const removeFromMySchedule = (data) => {
          if (data.title === 'TOTAL SOLAR ECLIPSE') return;
          const day = daysOfWeek.value[data.startTime.getDay()]
          if (savedData[day].length > 1) {
            let indexToSlice = 0;
            for (let i = 0; i < savedData[day].length; i++) {
              const event = savedData[day][i];
              if (event.id === data.id) {
                indexToSlice = i;
                break;
              }
            };
            const p1 = savedData[day].slice(0, indexToSlice);
            const p2 = savedData[day].slice(indexToSlice + 1);
            savedData[day] = p1.concat(p2);
          } else {
            savedData[day] = [];
          }
          localStorage.setItem(STORAGE, JSON.stringify(savedData))
        };
        const onSelect = (option) => {
          search.value = ""
        }
        const sortTags = (a, b) => {
          if (a === 'music' || a === 'presentation') return -1;
          if (b === 'music' || b === 'presentation') return 1;
          if (presentationTags.value.includes(b)) return -1;
          if (presentationTags.value.includes(a)) return 1;
          return 0
        }
        fetch("./utilities/events.json")
          .then((response) => response.json())
          .then((data) => {
            events.value = transformData(data)

            for (let event of events.value) {
              tags.value = tags.value.concat(event.tags)
              eventNames.value.push(event.title)
            }
            tags.value = removeDuplicates(tags.value).sort(sortTags)
            stages.value = removeDuplicates(events.value.map((event) => event.location)).sort((a, b) => {
              if (!sortedStages.includes(a) && !sortedStages.includes(b)) return 1;
              if (sortedStages.includes(a) && sortedStages.includes(b)) return sortedStages.indexOf(a) > sortedStages.indexOf(b) ? 1 : -1;
              if (sortedStages.includes(b)) return 1

              return -1;
            })

            fixData(events.value);
            fixScheduleSort();

            const foundEclipse = savedData['Monday'].find(event => event.title === 'TOTAL SOLAR ECLIPSE');
            if (!foundEclipse) {
              const eclipse = events.value.find(event => event.title === 'TOTAL SOLAR ECLIPSE');
              addToMySchedule(eclipse);
            }
          })
        const onTagChange = (search) => {
          console.log("search", search)
          if (search === 'music') {
            tags.value = tags.value.filter(tag => !presentationTags.value.includes(tag))
          }
        }
        const onTagRemove = (search) => {
          if (search === 'music') {
            tags.value = tags.value.filter(tag => !presentationTags.value.includes(tag))
          }
        }
        return {
          search,
          events,
          filteredEvents,
          tags,
          selectedTags,
          value,
          addToMySchedule,
          removeFromMySchedule,
          savedData,
          eventNames,
          onSelect,
          daysOfWeek,
          tagMap,
          coreStages,
          dayContainsEvent,
          selectedDays,
          selectedStages,
          stages,
          onTagChange,
        }
      }
    })

    app.component('multiselect', VueMultiselect)

    app.mount('#app')
  </script>
  <style>
    .cats {
      display: flex;
      align-items: center;
    }

    .github {
      position: fixed;
      top: 12px;
      right: 0;
      z-index: 999;
    }

    .spacex {
      position: relative;
      z-index: 9999;
    }

    .title {
      gap: 20px;
    }

    .event-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .houston {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 30px;
    }

    .lunar-rover {
      display: flex;
      flex-direction: column;
      flex: 1 0 50%;
      gap: 10px;
    }

    .timewarp {
      align-items: flex-end;
      gap: 2px;
      margin-left: auto;
    }

    .sky {
      --bulma-card-background-color: #d7f3ff;
      --bulma-primary-h: 197;
      --bulma-primary-s: 100%;
      --bulma-primary-l: 61%;

    }

    @media (prefers-color-scheme: dark) {

      .lonestar,
      .moon,
      .eclipse,
      .earth,
      .sky,
      .sun {
        --bulma-text-strong: black;
        --bulma-card-color: rgb(60, 60, 60);
      }

      .has-text-grey-dark,
      .is-color-grey-dark {
        color: #717d98 !important;
      }
    }

    .sun {
      --bulma-card-background-color: #fefee0;
      --bulma-primary-h: 49;
      --bulma-primary-s: 100%;
      --bulma-primary-l: 58%;

    }

    .sun [class*=has-text-primary],
    [class*=is-color-primary] {
      color: #d0ad0e !important;
    }

    .lonestar {
      --bulma-card-background-color: #ffcbcb;
      --bulma-primary-h: 0;
      --bulma-primary-s: 100%;
      --bulma-primary-l: 73%;

    }

    .earth {
      --bulma-card-background-color: #d1ffd1;
      --bulma-primary-h: 120;
      --bulma-primary-s: 52%;
      --bulma-primary-l: 57%;

    }

    .eclipse {
      --bulma-card-background-color: #c8c8c8;
    }

    .eclipse button.is-primary {
      background: hsl(0, 0%, 38%);
      color: white;
    }

    .eclipse [class*=has-text-primary],
    [class*=is-color-primary] {
      color: hsl(0, 0%, 38%) !important;
    }

    .moon {
      background: #bea9c8;
    }

    .moon [class*=has-text-primary],
    [class*=is-color-primary] {
      color: #8b4baa !important;
    }

    .moon button.is-primary {
      background: #8b4baa;
      color: white;
    }

    .tags {
      display: flex;
      gap: 3px;
    }
  </style>
</body>

</html>