<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedules</title>
  <link href="https://unpkg.com/vue-multiselect@3.0.0-beta.3/dist/vue-multiselect.esm.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
</head>

<body>
  <script type="importmap">
    { 
      "imports": {
        "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
        "vue-multiselect": "https://unpkg.com/vue-multiselect@3.0.0-beta.3/dist/vue-multiselect.esm.js"
      }
    }
  </script>
  <div id="app">
    <nav class="navbar" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-item" href="/">
          Go to Map
        </a>

        <!-- <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a> -->
      </div>
    </nav>
    <section class="section">
      <div class="container">
        <h1 class="title">
          Lineup
        </h1>
        <div class="grid">
          <div class="cell">
            <multiselect v-model="search" placeholder="Search by name.." :options="eventNames" @remove="onSelect" />
          </div>

          <div class="cell">
            <multiselect v-model="selectedTags" :options="tags" :multiple="true" :clear-on-select="false"
              :preserve-search="true" :close-on-select="false" placeholder="Select tag(s)"></multiselect>
          </div>
          <div class="cell">
            <button @click="selectedTags = []" class="button">Clear</button>
          </div>
        </div>
        <ul class="event-list">
          <li v-for="event in filteredEvents" :key="event.id">
            <div :class="`card ${event.location?.toLowerCase()?.replace(' ', '')}`">
              <div class="card-content">
                <h2 class="title is-flex is-justify-content-space-between">
                  <span class="">{{ event.title }}</span>
                  <div class="is-flex is-flex-direction-column">
                    <button class="button is-primary" type="button" @click="addToMySchedule(event)">
                      Add to schedule
                    </button>
                    <time class="is-size-4">{{ daysOfWeek[event.startTime.getDay()] }}</time>
                    <time :datetime="event.startTime" class="is-size-6">
                      {{ event.startTime.toLocaleTimeString([], {timeStyle: 'short'}) }} - {{
                      event.endTime.toLocaleTimeString([], {timeStyle: 'short'}) }}
                    </time>
                  </div>
                </h2>
                <h3 v-if="event.ig" class="subtitle">
                  <a :href="`https://www.${event.ig}`" class=" has-text-primary">@{{event.ig.split('/').pop()}}</a>
                </h3>
                <div class="content">
                  <p v-if="event.description">{{ event.description }}</p>
                  <p v-if="event.website">{{ event.website }}</p>
                  <div class="tags">
                    <span v-for="tag in event.tags" :key="tag"
                      :class="`tag ${Object.keys(tagMap).filter(k => tagMap[k].includes(tag))[0]}`">{{ tag }}
                    </span>
                  </div>
                </div>
                <img v-if="coreStages.includes(event.location)" class="symbol"
                  :src="`/assets/${event.location?.toLowerCase()?.replace(' ', '')}_stage.png`"
                  :alt="`${event.location} area`" />
                <h4 v-if="!coreStages.includes(event.location)" class="title is-size-4">Stage: {{event.location}}</h4>
              </div>
            </div>
          </li>
        </ul>
      </div>
  </div>
  </section>
  <script type="module">
    import { createApp, ref, onMounted, computed, reactive } from 'vue'
    import VueMultiselect from 'vue-multiselect'
    const tagMap = ref({
      "is-dark": ["dark", "emo", "rock", "experimental", "club", "space", "psywave", "acid", "tranquil", "art"],
      "is-primary": ["electronica", "synth", "bass", "indie", "sophistication", "slo-mo", "soundscape", "light show"],
      "is-link": ["house", "ethnic", "jungle", "retro", "lo-fi", "futuristic", "glitch", "math"],
      "is-info": ["blues", "afro", "folk", "psytrance", "dnb", "disco", "hardstyle", "hip hop", "astrology"],
      "is-warning": ["happy", "jazzy", "folktronica", "funky", "dubstep", "bpm", "humanitarianism", "comedy"],
      "is-danger": ["renegade", "industrial", "upbeat", "indigenous", "eerie", "classy", "AI"],
      "is-success": ["spiritual", "trippy", "vocals", "trance", "forest", "downtempo", "innovation"],
      "is-light": ["progressive", "consciousness", "techno", "remix", "dreamy", "acoustics", "crypto"],
    });
    const coreStages = ["Sky", "Sun", "Lone Star", "Earth", "Eclipse", "Moon"];
    const removeDuplicates = (arr) => arr.filter((v, i) => arr.indexOf(v) === i);
    const transformData = (data) => data.map((item) => {
      let newId = item.eventartistworkshoppresentation.replace(/[\s&]+/g, '-').toLowerCase()
      newId += '-' + item.starttime.replace(/[\s:.]+/g, '-').toLowerCase()
      return {
        id: newId,
        startTime: new Date(item.starttime),
        endTime: new Date(item.endtime),
        tags: item.tags.split(', '),
        title: item.eventartistworkshoppresentation,
        description: item.description,
        website: item.website,
        ig: item.ig,
        location: item.areastagelatlng
      }
    });

    const app = createApp({
      setup() {
        const daysOfWeek = ref(['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']);
        const mySchedule = reactive([]);
        const value = ref();
        const events = ref([])
        const eventNames = ref([]);
        const stages = ref([])
        const days = ref([])
        const eventTypes = ref([])
        const search = ref('')
        const selectedTags = ref([])
        const tags = ref([])
        const filteredEvents = computed({
          get() {
            return events.value.filter((event) => {
              return event.title.toLowerCase().includes(search.value.toLowerCase()) && (selectedTags.value.length === 0 || selectedTags.value.every((tag) => event.tags.includes(tag)))
            }).sort((a, b) => a.startTime - b.startTime)
          }
        })

        const detectConflict = () => {
          for (let i = 0; i < mySchedule.length - 1; i++) {
            if (mySchedule[i].endTime > mySchedule[i + 1].startTime) {
              console.log("conflict detected")
            }
          }
        }
        const addToMySchedule = (data) => {
          mySchedule.push(data);
          mySchedule.sort((a, b) => a.startTime - b.startTime);
          console.log("what is mySchedule", mySchedule)

        }
        const onSelect = (option) => {
          search.value = ""
        }
        fetch("./utilities/events.json")
          .then((response) => response.json())
          .then((data) => {
            events.value = transformData(data)
            for (let event of events.value) {
              tags.value = removeDuplicates(tags.value.concat(event.tags))
              eventNames.value.push(event.title)
              stages.value = removeDuplicates(stages.value.concat(event.location))
            }
            // tags.value = removeDuplicates(events.value.flatMap((event) => event.tags))
            // eventNames.value = events.value.map((event) => event.title)
          })
        return {
          search,
          events,
          filteredEvents,
          tags,
          selectedTags,
          value,
          addToMySchedule,
          eventNames,
          onSelect,
          daysOfWeek,
          tagMap,
          coreStages,
        }
      }
    })

    app.component('multiselect', VueMultiselect)

    app.mount('#app')
  </script>
  <style>
    .title {
      gap: 20px;
    }

    .event-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .sky {
      --bulma-card-background-color: #d7f3ff;
      --bulma-primary-h: 197;
      --bulma-primary-s: 100%;
      --bulma-primary-l: 61%;
    }

    .sun {
      --bulma-card-background-color: #fefee0;
      --bulma-primary-h: 49;
      --bulma-primary-s: 100%;
      --bulma-primary-l: 58%;
    }

    .lonestar {
      --bulma-card-background-color: #ffcbcb;
      --bulma-primary-h: 0;
      --bulma-primary-s: 100%;
      --bulma-primary-l: 73%;
    }

    .earth {
      --bulma-card-background-color: #d1ffd1;
      --bulma-primary-h: 120;
      --bulma-primary-s: 52%;
      --bulma-primary-l: 57%;
    }

    .eclipse {
      --bulma-card-background-color: #c8c8c8;
    }

    .eclipse button.is-primary {
      background: hsl(0, 0%, 38%);
      color: white;
    }

    .moon {
      background: #bea9c8;
    }

    .moon button.is-primary {
      background: #8b4baa;
      color: white;
    }

    .tags {
      display: flex;
      gap: 3px;
    }
  </style>
</body>

</html>